
<!DOCTYPE html>
<html>
<head>
  <title>Control de Stock Visual</title>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <h2>ğŸ“¸ EscaneÃ¡ un pÃ³ster</h2>
  <video id="webcam" autoplay playsinline width="224" height="224"></video>
  <h3>ğŸ§¾ PÃ³ster detectado: <span id="result">Ninguno</span></h3>
  <button onclick="registrarVenta()">âœ… Registrar venta</button>
  <p id="status"></p>

  <script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/7PSporqda/";
    let model, webcam, labelContainer, maxPredictions;
    let resultadoActual = "";

    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const flip = true;
      webcam = new tmImage.Webcam(224, 224, flip);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      document.getElementById("webcam").appendChild(webcam.canvas);
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let bestGuess = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
      if (bestGuess.probability > 0.85) {
        resultadoActual = bestGuess.className;
        document.getElementById("result").innerText = resultadoActual;
      }
    }

    function registrarVenta() {
      if (!resultadoActual) {
        document.getElementById("status").innerText = "âŒ No se detectÃ³ ningÃºn pÃ³ster aÃºn.";
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbwzJK4_oJ-ZFNOJ6DcY2FU04Ux00QWOHDaPotbyW0TAXiH2NIjtgv8hrtRjMMnF8JxC/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `producto=${encodeURIComponent(resultadoActual)}&cantidad=1`
      })
      .then(response => response.text())
      .then(data => {
        document.getElementById("status").innerText = `âœ… Venta registrada de: ${resultadoActual}`;
      })
      .catch(error => {
        document.getElementById("status").innerText = "âŒ Error al registrar la venta.";
      });
    }

    init();
  </script>
</body>
</html>
